---
# main playbook file for register_LDAP

- name: Register user in the LDAP server
  hosts: all
  become: false
  pre_tasks:
    - name: Get highest uid
      shell: "set -o pipefail && getent passwd | grep -v nobody | awk -F : '$3>h{h=$3;u=$1}END{print h}'"
      args:
        executable: /bin/bash
      register: uid_result
      changed_when: false
      when: uid is not defined

    - name: Set uid
      set_fact:
        uid: "{{ uid_result.stdout | int + 1 }}"
      when: uid is not defined

    - name: Run handlers
      meta: flush_handlers
    - name: Show uid
      debug:
        var: uid
  tasks:
    - name: Register user in the LDAP server
      ldap_entry:
        dn: "cn={{ full_name }},{{ users_base_DN }}"
        objectClass:
          - inetOrgPerson
          - posixAccount
          - top
        server_uri: "{{ openldap_server_uri }}"
        start_tls: false
        validate_certs: "{{ testing is undefined and validate_certs }}"
        bind_dn: "{{ bind_DN }}"
        bind_pw: "{{ bind_credentials }}"
        attributes:
          userPassword: "{{ password }}"
          mail: "{{ email }}"
          gidNumber: "{{ gid }}"
          givenName: "{{ user_name }}"
          sn: "{{ surname }}"
          homeDirectory: "{{ home_directory }}"
          uidNumber: "{{ uid }}"
          uid: "{{ nick }}"
